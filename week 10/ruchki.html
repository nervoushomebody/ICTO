<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HandPose - –û–±—á–∏—Å–ª–µ–Ω–Ω—è –∫—É—Ç—ñ–≤ –º—ñ–∂ –ø–∞–ª—å—Ü—è–º–∏</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose@latest"></script>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }
        
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
        }
        
        #results {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            max-width: 350px;
            font-size: 12px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: -1;
        }
        
        .angle-info {
            margin: 8px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            border-left: 3px solid #4CAF50;
        }
        
        .finger-length {
            color: #88ff88;
            font-weight: bold;
        }
        
        .angle-value {
            color: #ffff88;
            font-weight: bold;
            font-size: 14px;
        }
        
        #status {
            color: #ff8888;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <video id="video" autoplay muted playsinline></video>
    
    <div id="controls">
        <h3>HandPose Detector</h3>
        <button id="start-btn">–ü–æ—á–∞—Ç–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è</button>
        <button id="stop-btn" disabled>–ó—É–ø–∏–Ω–∏—Ç–∏</button>
        <div id="status">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ü–æ—á–∞—Ç–∏" –¥–ª—è –∑–∞–ø—É—Å–∫—É</div>
    </div>
    
    <div id="results">
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –æ–±—á–∏—Å–ª–µ–Ω—å</h3>
        <div id="finger-lengths"></div>
        <div id="angles-between-fingers"></div>
    </div>

    <script>
        let model = null;
        let video = null;
        let isRunning = false;
        let animationFrame = null;

        // –Ü–Ω–¥–µ–∫—Å–∏ –∫–ª—é—á–æ–≤–∏—Ö —Ç–æ—á–æ–∫ –¥–ª—è –ø–∞–ª—å—Ü—ñ–≤
        const FINGER_INDICES = {
            thumb: [1, 2, 3, 4],      // –í–µ–ª–∏–∫–∏–π –ø–∞–ª–µ—Ü—å: CMC, MCP, IP, TIP
            index: [5, 6, 7, 8],      // –í–∫–∞–∑—ñ–≤–Ω–∏–π: MCP, PIP, DIP, TIP
            middle: [9, 10, 11, 12],  // –°–µ—Ä–µ–¥–Ω—ñ–π: MCP, PIP, DIP, TIP
            ring: [13, 14, 15, 16],   // –ë–µ–∑—ñ–º–µ–Ω–Ω–∏–π: MCP, PIP, DIP, TIP
            pinky: [17, 18, 19, 20]   // –ú—ñ–∑–∏–Ω–µ—Ü—å: MCP, PIP, DIP, TIP
        };

        const FINGER_NAMES = {
            thumb: '–í–µ–ª–∏–∫–∏–π',
            index: '–í–∫–∞–∑—ñ–≤–Ω–∏–π', 
            middle: '–°–µ—Ä–µ–¥–Ω—ñ–π',
            ring: '–ë–µ–∑—ñ–º–µ–Ω–Ω–∏–π',
            pinky: '–ú—ñ–∑–∏–Ω–µ—Ü—å'
        };

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞–º–µ—Ä–∏ —Ç–∞ –º–æ–¥–µ–ª—ñ
        async function init() {
            try {
                document.getElementById('status').textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ...';
                
                // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è HandPose –º–æ–¥–µ–ª—ñ
                model = await handpose.load();
                console.log('‚úÖ HandPose –º–æ–¥–µ–ª—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');
                
                // –î–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'user'
                    }
                });
                
                video = document.getElementById('video');
                video.srcObject = stream;
                
                await new Promise(resolve => {
                    video.onloadedmetadata = resolve;
                });
                
                document.getElementById('status').textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ –¥–æ —Ä–æ–±–æ—Ç–∏';
                document.getElementById('start-btn').disabled = false;
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó:', error);
                document.getElementById('status').textContent = '–ü–æ–º–∏–ª–∫–∞: ' + error.message;
            }
        }

        // –û–±—á–∏—Å–ª–µ–Ω–Ω—è –¥–æ–≤–∂–∏–Ω–∏ –ø–∞–ª—å—Ü—è (–≤—ñ–¥ MCP –¥–æ TIP)
        function calculateFingerLength(landmarks, fingerIndices) {
            const mcpIndex = fingerIndices[0]; // MCP —Ç–æ—á–∫–∞
            const tipIndex = fingerIndices[3]; // TIP —Ç–æ—á–∫–∞
            
            const mcp = landmarks[mcpIndex];
            const tip = landmarks[tipIndex];
            
            const dx = tip[0] - mcp[0];
            const dy = tip[1] - mcp[1];
            const dz = tip[2] - mcp[2];
            
            return Math.sqrt(dx*dx + dy*dy + dz*dz);
        }

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤–µ–∫—Ç–æ—Ä–∞ –≤—ñ–¥ MCP –¥–æ TIP
        function createFingerVector(landmarks, fingerIndices) {
            const mcpIndex = fingerIndices[0];
            const tipIndex = fingerIndices[3];
            
            const mcp = landmarks[mcpIndex];
            const tip = landmarks[tipIndex];
            
            return [
                tip[0] - mcp[0],
                tip[1] - mcp[1], 
                tip[2] - mcp[2]
            ];
        }

        // –û–±—á–∏—Å–ª–µ–Ω–Ω—è —Å–∫–∞–ª—è—Ä–Ω–æ–≥–æ –¥–æ–±—É—Ç–∫—É –≤–µ–∫—Ç–æ—Ä—ñ–≤
        function dotProduct(v1, v2) {
            return v1[0]*v2[0] + v1[1]*v2[1] + v1[2]*v2[2];
        }

        // –û–±—á–∏—Å–ª–µ–Ω–Ω—è –¥–æ–≤–∂–∏–Ω–∏ –≤–µ–∫—Ç–æ—Ä–∞
        function vectorLength(v) {
            return Math.sqrt(v[0]*v[0] + v[1]*v[1] + v[2]*v[2]);
        }

        // –û–±—á–∏—Å–ª–µ–Ω–Ω—è –∫—É—Ç–∞ –º—ñ–∂ –¥–≤–æ–º–∞ –≤–µ–∫—Ç–æ—Ä–∞–º–∏ (–≤ –≥—Ä–∞–¥—É—Å–∞—Ö)
        function calculateAngleBetweenVectors(v1, v2) {
            const dot = dotProduct(v1, v2);
            const len1 = vectorLength(v1);
            const len2 = vectorLength(v2);
            
            if (len1 === 0 || len2 === 0) return 0;
            
            const cosAngle = dot / (len1 * len2);
            // –û–±–º–µ–∂—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è
            const clampedCos = Math.max(-1, Math.min(1, cosAngle));
            
            return Math.acos(clampedCos) * (180 / Math.PI);
        }

        // –û—Å–Ω–æ–≤–Ω–∏–π —Ü–∏–∫–ª —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è
        async function detectHands() {
            if (!isRunning || !model || !video) return;

            try {
                const predictions = await model.estimateHands(video);
                
                if (predictions.length > 0) {
                    const landmarks = predictions[0].landmarks;
                    
                    // –û–±—á–∏—Å–ª–µ–Ω–Ω—è –¥–æ–≤–∂–∏–Ω –ø–∞–ª—å—Ü—ñ–≤
                    const fingerLengths = {};
                    const fingerVectors = {};
                    
                    for (const [fingerName, indices] of Object.entries(FINGER_INDICES)) {
                        fingerLengths[fingerName] = calculateFingerLength(landmarks, indices);
                        fingerVectors[fingerName] = createFingerVector(landmarks, indices);
                    }
                    
                    // –û–±—á–∏—Å–ª–µ–Ω–Ω—è –∫—É—Ç—ñ–≤ –º—ñ–∂ —Å—É—Å—ñ–¥–Ω—ñ–º–∏ –ø–∞–ª—å—Ü—è–º–∏
                    const angles = {};
                    const fingerOrder = ['thumb', 'index', 'middle', 'ring', 'pinky'];
                    
                    for (let i = 0; i < fingerOrder.length - 1; i++) {
                        const finger1 = fingerOrder[i];
                        const finger2 = fingerOrder[i + 1];
                        
                        const angle = calculateAngleBetweenVectors(
                            fingerVectors[finger1], 
                            fingerVectors[finger2]
                        );
                        
                        angles[`${finger1}_${finger2}`] = angle;
                    }
                    
                    // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
                    displayResults(fingerLengths, angles);
                    
                } else {
                    document.getElementById('finger-lengths').innerHTML = '<div style="color: #ff8888;">–†—É–∫–∞ –Ω–µ –≤–∏—è–≤–ª–µ–Ω–∞</div>';
                    document.getElementById('angles-between-fingers').innerHTML = '';
                }
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è:', error);
            }
            
            animationFrame = requestAnimationFrame(detectHands);
        }

        // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
        function displayResults(fingerLengths, angles) {
            // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–æ–≤–∂–∏–Ω –ø–∞–ª—å—Ü—ñ–≤
            let lengthsHTML = '<h4>–î–æ–≤–∂–∏–Ω–∏ –ø–∞–ª—å—Ü—ñ–≤ (–ø—ñ–∫—Å–µ–ª—ñ):</h4>';
            for (const [fingerName, length] of Object.entries(fingerLengths)) {
                lengthsHTML += `
                    <div class="angle-info">
                        <span>${FINGER_NAMES[fingerName]}:</span> 
                        <span class="finger-length">${length.toFixed(1)} px</span>
                    </div>
                `;
            }
            document.getElementById('finger-lengths').innerHTML = lengthsHTML;
            
            // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫—É—Ç—ñ–≤ –º—ñ–∂ –ø–∞–ª—å—Ü—è–º–∏
            let anglesHTML = '<h4>–ö—É—Ç–∏ –º—ñ–∂ –ø–∞–ª—å—Ü—è–º–∏:</h4>';
            for (const [fingerPair, angle] of Object.entries(angles)) {
                const [finger1, finger2] = fingerPair.split('_');
                anglesHTML += `
                    <div class="angle-info">
                        <span>${FINGER_NAMES[finger1]} ‚Üî ${FINGER_NAMES[finger2]}:</span><br>
                        <span class="angle-value">${angle.toFixed(1)}¬∞</span>
                    </div>
                `;
            }
            document.getElementById('angles-between-fingers').innerHTML = anglesHTML;
        }

        // –ó–∞–ø—É—Å–∫ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è
        function startDetection() {
            if (!model) {
                alert('–ú–æ–¥–µ–ª—å —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞!');
                return;
            }
            
            isRunning = true;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
            document.getElementById('status').textContent = 'üîÑ –†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–µ';
            
            detectHands();
        }

        // –ó—É–ø–∏–Ω–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è
        function stopDetection() {
            isRunning = false;
            
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
            
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('status').textContent = '‚è∏Ô∏è –†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –∑—É–ø–∏–Ω–µ–Ω–æ';
            
            document.getElementById('finger-lengths').innerHTML = '';
            document.getElementById('angles-between-fingers').innerHTML = '';
        }

        // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
        document.getElementById('start-btn').addEventListener('click', startDetection);
        document.getElementById('stop-btn').addEventListener('click', stopDetection);

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.addEventListener('load', init);
        
        // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
        window.addEventListener('error', (e) => {
            console.error('–ì–ª–æ–±–∞–ª—å–Ω–∞ –ø–æ–º–∏–ª–∫–∞:', e.error);
            document.getElementById('status').textContent = '–ü–æ–º–∏–ª–∫–∞: ' + e.error.message;
        });
    </script>
</body>
</html>
